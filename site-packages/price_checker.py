import hotel_prices
from google_sheets_client import google_sheets_client
import datetime

def execute(items):
    for item in items:
        url = item['url']
        spreadsheet_id = item['spreadsheet_id']
        
        hotels = hotel_prices.check_booking_com(url)
        client = google_sheets_client('sheets.googleapis.com-hotel-log.json')

        for hotel in hotels:
            if not client.does_sheet_exist(spreadsheet_id, hotel['name']):
                client.create_sheet(spreadsheet_id, hotel['name'])
                client.add_new_row(spreadsheet_id, hotel['name'] + '!A1:D1', {'range': hotel['name'] + '!A1:D1', 'values': [['Date', 'Name', 'Rating', 'Price', 'Discounted']]})
                sheet_id = client.get_sheet_id(spreadsheet_id, hotel['name'])
                client.format_spreadsheet(spreadsheet_id, sheet_id)
            range_name = hotel['name'] + '!A2:D2'
            update_body = {'range': hotel['name'] + '!A2:D2', 'values': [[str(datetime.datetime.now()), hotel['name'], hotel['score'], hotel['price'], hotel['discounted']]]}
            client.add_new_row(spreadsheet_id, range_name, update_body)
